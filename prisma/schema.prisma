// Time Master - Database Schema (Prisma 7: URLs in prisma.config.ts)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Main User model
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String?   // Null if SSO user
  name          String
  avatar        String?
  
  role          UserRole  @default(USER)
  userType      UserType  @default(EXTERNAL)
  plan          PlanType  @default(FREE)
  
  // Account status
  isDisabled        Boolean   @default(false)  // Admin can disable accounts
  disabledAt        DateTime?                  // When account was disabled
  disabledReason    String?                    // Why account was disabled
  emailVerified     Boolean   @default(false)  // Email verification status
  emailVerifiedAt   DateTime?                  // When email was verified
  
  // SSO fields
  ssoProvider   String?   // 'sso', 'google', etc.
  ssoId         String?   // External SSO ID
  
  // Stripe fields
  stripeCustomerId     String?
  stripeSubscriptionId String?
  subscriptionStatus   String?   // 'active', 'canceled', 'past_due', 'paused'
  subscriptionEndDate  DateTime?
  
  // Billing tracking
  firstPaymentDate     DateTime? // When user first paid
  lastPaymentDate      DateTime? // Most recent successful payment
  invoicePending       Boolean   @default(false) // True when invoice awaits payment
  lastInvoiceId        String?   // Stripe invoice ID for reference
  
  // Plan limits override (for internal users or special cases)
  unlimitedAccess Boolean @default(false)
  
  // Admin-assigned plan override (supersedes Stripe subscription)
  adminAssignedPlan     PlanType?   // Plan assigned by admin
  adminAssignedPlanAt   DateTime?   // When admin assigned the plan
  adminAssignedPlanBy   String?     // Admin who assigned the plan
  adminAssignedPlanNote String?     // Note about why plan was assigned
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  goals          Goal[]
  timeEntries    TimeEntry[]
  scheduleBlocks ScheduleBlock[]
  tasks          Task[]
  categories     Category[]
  labels         Label[]
  notes          Note[]
  sharedWithMe   SharedAccess[] @relation("SharedWith")
  sharedByMe     SharedAccess[] @relation("SharedBy")
  feedbacks      Feedback[]
  feedbackResponses FeedbackResponse[]
  notifications Notification[]
  releaseNotesSeen ReleaseNoteSeen[]
  
  @@index([email])
  @@index([ssoProvider, ssoId])
}

// Goals for tracking objectives
model Goal {
  id            String       @id @default(uuid())
  title         String
  description   String?
  category      String?      // Category value reference
  targetHours   Float
  loggedHours   Float        @default(0)
  deadline      DateTime?
  status        GoalStatus   @default(ACTIVE)
  color         String       @default("#FFD700")
  order         Int          @default(0)
  
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  timeEntries    TimeEntry[]
  scheduleBlocks ScheduleBlock[]
  tasks          Task[]
  labels         GoalLabel[]
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([category])
}

// Time entries for logging work
model TimeEntry {
  id            String    @id @default(uuid())
  taskName      String
  taskTitle     String?   // Snapshot of linked task title for reporting
  duration      Int       // Duration in minutes
  date          DateTime
  startedAt     DateTime? // When the work started
  dayOfWeek     Int       // 0-6 (Sunday-Saturday)
  notes         String?
  
  // Progress percentage at time of entry
  progressPercent Float?
  
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  goalId        String?
  goal          Goal?     @relation(fields: [goalId], references: [id], onDelete: SetNull)
  
  // Link to schedule block if logged from schedule
  scheduleBlockId String?
  scheduleBlock   ScheduleBlock? @relation(fields: [scheduleBlockId], references: [id], onDelete: SetNull)

  taskId        String?
  task          Task?     @relation(fields: [taskId], references: [id], onDelete: SetNull)
  source        TimeEntrySource @default(TRACKER)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([userId])
  @@index([date])
  @@index([goalId])
}

// Schedule blocks for planning
model ScheduleBlock {
  id            String           @id @default(uuid())
  title         String
  startTime     String           // "09:00" format
  endTime       String           // "12:00" format
  dayOfWeek     Int              // 0-6 (Sunday-Saturday)
  category      String?          // Category value reference
  color         String           @default("#FFD700")
  isRecurring   Boolean          @default(true)
  seriesId      String           @default(uuid())
  
  userId        String
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  goalId        String?
  goal          Goal?            @relation(fields: [goalId], references: [id], onDelete: SetNull)
  
  timeEntries   TimeEntry[]
  tasks         Task[]
  
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  @@index([userId])
  @@index([dayOfWeek])
  @@index([seriesId])
}

// Tasks linked to schedule blocks and goals
model Task {
  id              String       @id @default(uuid())
  title           String
  description     String?
  status          TaskStatus   @default(BACKLOG)
  category        String?      // Category value reference
  estimatedMinutes Int?
  actualMinutes   Int?
  order           Int          @default(0)
  dueDate         DateTime?
  completedAt     DateTime?
  notes           String?      // Task-specific notes

  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  scheduleBlockId String?
  scheduleBlock   ScheduleBlock? @relation(fields: [scheduleBlockId], references: [id], onDelete: SetNull)

  goalId          String?
  goal            Goal?        @relation(fields: [goalId], references: [id], onDelete: SetNull)

  timeEntries     TimeEntry[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([userId])
  @@index([scheduleBlockId])
  @@index([goalId])
  @@index([status])
}

// Shared access for collaboration
model SharedAccess {
  id            String    @id @default(uuid())
  
  // User who shared
  ownerId       String
  owner         User      @relation("SharedBy", fields: [ownerId], references: [id], onDelete: Cascade)
  
  // User who received access (null for pending invites to non-existent users)
  sharedWithId  String?
  sharedWith    User?     @relation("SharedWith", fields: [sharedWithId], references: [id], onDelete: Cascade)
  
  // Invitation email (for pending invites)
  inviteEmail   String?
  inviteToken   String?   @unique
  inviteExpires DateTime?
  
  // Public link flag (public links don't require email and can be shared openly)
  isPublicLink  Boolean   @default(false)
  
  // Access level
  accessLevel   String     @default("VIEW") // "VIEW" or "EDIT"
  
  isAccepted    Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Unique constraint: one accepted share per owner-sharedWithId pair
  // Note: Multiple pending invites with same ownerId+inviteEmail are prevented by application logic
  @@unique([ownerId, sharedWithId], name: "unique_owner_shared_with")
  @@unique([ownerId, inviteEmail], name: "unique_owner_invite_email")
  @@index([ownerId])
  @@index([sharedWithId])
  @@index([inviteEmail])
}

// Audit log for tracking changes
model AuditLog {
  id          String   @id @default(uuid())
  userId      String
  action      String
  entityType  String
  entityId    String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// Category for goals, schedule blocks, and tasks
model Category {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String   // Display name
  value     String   // Unique value/slug
  color     String
  isDefault Boolean  @default(false)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, value])
  @@index([userId])
}

// Label for filtering goals (e.g., Q1, Q2, Q3, Q4, 2025, Priority)
model Label {
  id        String      @id @default(uuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String      // Display name
  value     String      // Unique value/slug
  color     String      @default("#6B7280")
  isDefault Boolean     @default(false)
  order     Int         @default(0)
  goals     GoalLabel[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([userId, value])
  @@index([userId])
}

// Many-to-many relationship between Goals and Labels
model GoalLabel {
  id        String   @id @default(uuid())
  goalId    String
  goal      Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  labelId   String
  label     Label    @relation(fields: [labelId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([goalId, labelId])
  @@index([goalId])
  @@index([labelId])
}

// Notes with hierarchical structure (OneNote-like)
model Note {
  id          String   @id @default(uuid())
  title       String   @default("Untitled")
  content     String   @default("[]") // JSON string of blocks
  icon        String?  // Emoji icon
  color       String?  // Color theme
  
  // Hierarchical structure
  parentId    String?
  parent      Note?    @relation("NoteHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Note[]   @relation("NoteHierarchy")
  
  order       Int      @default(0)    // For ordering within parent
  isExpanded  Boolean  @default(true) // Tree expansion state
  isFavorite  Boolean  @default(false)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([parentId])
  @@index([isFavorite])
}

// User feedback
model Feedback {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  emoji       Int?      // 0 = love, 1 = okay, 2 = not great, 3 = hate
  text        String?   // Feedback text content
  
  isArchived  Boolean   @default(false)
  archivedAt  DateTime?
  archivedBy  String?   // Admin user ID who archived it
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  responses   FeedbackResponse[]
  
  @@index([userId])
  @@index([isArchived])
  @@index([createdAt])
}

model FeedbackResponse {
  id         String   @id @default(uuid())
  feedbackId String
  feedback   Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  senderId   String
  sender     User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  message    String
  createdAt  DateTime @default(now())

  @@index([feedbackId])
  @@index([senderId])
  @@index([createdAt])
}

model Notification {
  id        String            @id @default(uuid())
  userId    String
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  body      String?
  data      Json?
  readAt    DateTime?
  createdAt DateTime          @default(now())

  @@index([userId, createdAt])
  @@index([userId, readAt])
}

model ReleaseNote {
  id          String   @id @default(uuid())
  version     String   @unique
  title       String
  content     String
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  seenBy      ReleaseNoteSeen[]
}

model ReleaseNoteSeen {
  id        String   @id @default(uuid())
  noteId    String
  note      ReleaseNote @relation(fields: [noteId], references: [id], onDelete: Cascade)
  userId    String
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  seenAt    DateTime @default(now())

  @@unique([noteId, userId])
  @@index([userId])
}

// User roles and types
enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
}

enum UserType {
  INTERNAL    // Internal members - always free
  EXTERNAL    // External users - need subscription
}

enum PlanType {
  FREE
  BASIC     // $7/month - Basic features
  PRO       // $5/month promotional price - All features
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  PAUSED
}

enum TaskStatus {
  BACKLOG
  TODO
  DOING
  DONE
}

enum NotificationType {
  FEEDBACK_REPLY
}

enum TimeEntrySource {
  COMPLETION
  TRACKER
}
